name: 'Library CI'

on:
   workflow_call:
      inputs:
         node-version:
            description: 'Node.js version to use'
            default: '24'
            required: false
            type: string
         version:
            description: 'Version number for this release (e.g. 1.2.3)'
            required: false
            type: string
         build-artifact:
            description: 'Whether to build and upload artifacts'
            required: false
            default: false
            type: boolean

jobs:
   library-ci:
      runs-on: ubuntu-latest

      steps:
         - name: Checkout
           uses: actions/checkout@v4
           with:
              ref: ${{ github.ref_name }}

         - name: Use Node.js ${{ inputs.node-version }}
           uses: actions/setup-node@v4
           with:
              node-version: ${{ inputs.node-version }}
              cache: npm

         - name: Install dependencies
           run: npm ci

         - name: Run eslint
           run: npx eslint .

         - name: Run tests
           run: npm run test:coverage -- --ci --reporters=default

         #  Creating tag before build to ensure the compiled code has the correct version
         #  Later publishing the library relies the artifacts are compiled with the updated package.json
         - name: Create git tag
           if: ${{ inputs.build-artifact == true }}
           id: tag
           run: |
              TAG="${{ github.event.inputs.version }}"
              VERSION="v${{ github.event.inputs.version }}"

              echo "Checking if tag $VERSION exists..."
              git fetch origin --tags --force --prune

              if git rev-parse "$VERSION" >/dev/null 2>&1; then
                echo "‚úÖ Tag $VERSION already exists. Skipping tag creation."
               else
                  echo "üè∑Ô∏è Releasing version $VERSION"

                  git config user.name "${{ github.actor }}"
                  git config user.email "${{ github.actor }}@users.noreply.github.com"

                  # This handles package.json + commit + tag
                  npm version $TAG -m "auto commit: release v%s"

                  # Push commit + tag
                  git push origin ${{ github.ref_name }} --follow-tags
               fi

         - name: Build the library
           if: ${{ inputs.build-artifact == true }}
           env:
              NODE_ENV: production
           run: npm run compile

         - name: Cleans up temporary files
           if: ${{ inputs.build-artifact == true }}
           run: npm run clean:meta

         - name: Package build as ZIP
           if: ${{ inputs.build-artifact == true }}
           run: |
              # Ensure build output exists
              if [ ! -d "dist" ]; then
                 echo "‚ùå Error: 'dist' directory not found. Run your build step first."
                 exit 1
              fi
              cd dist/
              zip -r build-${{ github.event.inputs.version }}-${{ github.sha }}.zip lib/*

         - name: Upload the library as an artifact
           if: ${{ inputs.build-artifact == true }}
           uses: actions/upload-artifact@v4
           with:
              name: build-${{ github.event.inputs.version }}-${{ github.sha }}
              path: dist/build-${{ github.event.inputs.version }}-${{ github.sha }}.zip
              if-no-files-found: ignore
