name: 'CI (validation)'

on:
   workflow_call:
      inputs:
         node-version:
            description: 'Node.js version to use'
            default: '24'
            required: false
            type: string
         version:
            description: 'Version number for this release (e.g. 1.2.3)'
            required: false
            type: string
         branch:
            description: 'Version number for this release (e.g. 1.2.3)'
            required: false
            type: string
         build-artifact:
            description: 'Whether to build and upload artifacts'
            required: false
            default: false
            type: boolean

jobs:
   lint-and-test:
      runs-on: ubuntu-latest

      steps:
         # 1ï¸âƒ£ Checkout the repo
         - name: Checkout
           uses: actions/checkout@v4
           with:
              ref: ${{ inputs.version || github.ref }}

         # 2ï¸âƒ£ Setup Node.js (optional, for Vite/Node projects)
         - name: Use Node.js ${{ inputs.node-version }}
           uses: actions/setup-node@v4
           with:
              node-version: ${{ inputs.node-version }}
              cache: npm

         # 3ï¸âƒ£ Install dependencies
         - name: Install dependencies
           run: npm ci

         # 4ï¸âƒ£ Validate the code with the linter
         - name: Run eslint
           run: npx eslint .

         # 5ï¸âƒ£ Run all tests
         - name: Run tests
           run: npm run test:coverage -- --ci --reporters=default

         # ğŸ—ï¸ Build step if build-artifact flag is set
         - name: Build the demo projects
           if: ${{ inputs.build-artifact }}
           run: npm run build:web

         # ğŸ“¦ Upload artifact if build-artifact flag is set
         - name: Upload the demo as an artifact
           if: ${{ inputs.build-artifact }}
           uses: actions/upload-artifact@v4
           with:
              name: demo-${{ github.ref_name }}-${{ inputs.version || 'latest' }}
              path: src/demo/web/dist/

         # ğŸ—ï¸ Build step if build-artifact flag is set
         - name: Build the library
           if: ${{ inputs.build-artifact }}
           run: npm run compile:lib

         # ğŸ“¦ Upload artifact if build-artifact flag is set
         - name: Upload the library as an artifact
           if: ${{ inputs.build-artifact }}
           uses: actions/upload-artifact@v4
           with:
              name: build-${{ github.ref_name }}-${{ inputs.version || 'latest' }}
              path: dist/

         # ğŸ‘€ For testing purposes
         - name: Show build folder contents
           if: ${{ inputs.build-artifact }}
           run: |
              echo "ğŸ“ Listing files in $(pwd)"
              ls -R .
